<!DOCTYPE html>
<html>

<head>
  <title>RSVP News Settings</title>
  <link rel='stylesheet' type='text/css' href='css/slate.min.css'>
  <script src='js/slate.min.js'></script>
  <style>
    .title {
      padding: 15px 10px;
      text-transform: uppercase;
      font-family: 'PT Sans', sans-serif;
      font-size: 1.2em;
      font-weight: 500;
      color: #888888;
      text-align: center;
    }

    .feed-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .feed-item {
      display: flex;
      align-items: center;
      padding: 12px 10px;
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      user-select: none;
    }

    .feed-item.dragging {
      cursor: grabbing;
    }

    .feed-item.dragging {
      opacity: 0.5;
      background: #e3f2fd;
    }

    .feed-item.drag-over {
      border-top: 2px solid #1a73e8;
    }

    .feed-name {
      flex: 1;
      font-size: 1em;
      color: #333;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .feed-drag-handle {
      color: #999;
      margin-right: 10px;
      font-size: 1.2em;
      cursor: grab;
      padding: 5px;
    }

    .feed-drag-handle:active {
      cursor: grabbing;
    }

    .feed-delete {
      color: #e53935;
      font-size: 1.2em;
      padding: 5px 10px;
      cursor: pointer;
      border: none;
      background: none;
    }

    .feed-delete:hover {
      color: #b71c1c;
    }

    .add-feed-btn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      font-size: 1em;
      cursor: pointer;
      margin-top: 10px;
      border-radius: 4px;
    }

    .add-feed-btn:hover {
      background: #45a049;
    }

    .reset-feed-btn {
      width: 100%;
      padding: 12px;
      background: #ff5722;
      color: white;
      border: none;
      font-size: 1em;
      cursor: pointer;
      margin-top: 5px;
      border-radius: 4px;
    }

    .reset-feed-btn:hover {
      background: #e64a19;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }

    .modal-title {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }

    .modal-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
      box-sizing: border-box;
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }

    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
    }

    .modal-btn-cancel {
      background: #e0e0e0;
      color: #333;
    }

    .modal-btn-add {
      background: #1a73e8;
      color: white;
    }
  </style>
</head>

<body>
  <h1 class='title'>RSVP News Settings</h1>

  <div class='item-container'
    style='background-color: #1a73e8; border-radius: 8px; margin: 10px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);'>
    <div style='color: #ffffff; text-align: center;'>
      <strong style='font-size: 1.2em;'>RSVP Speed Reading</strong>
      <p style='margin: 10px 0 0 0; font-size: 0.9em; line-height: 1.4;'>
        RSVP (Rapid Serial Visual Presentation) displays words one at a time in the same spot,
        eliminating eye movements and enabling ultra-fast reading.
        The Spritz method can boost your reading speed up to 1000 words per minute!
      </p>
    </div>
  </div>

  <div class='item-container'>
    <div class='item-container-header'>RSS Feeds</div>
    <div class='item-container-content' style='padding: 0;'>
      <ul id='feed-list' class='feed-list'>
        <!-- Feeds will be populated by JavaScript -->
      </ul>
      <div style='padding: 10px;'>
        <button type='button' class='add-feed-btn' onclick='showAddFeedModal()'>+ Add Feed</button>
        <button type='button' class='reset-feed-btn' onclick='resetFeeds()'>↺ Reset to Default</button>
      </div>
    </div>
  </div>

  <!-- Add Feed Modal -->
  <div id='add-feed-modal' class='modal'>
    <div class='modal-content'>
      <div class='modal-title'>Add New Feed</div>
      <input type='text' id='modal-feed-name' class='modal-input' placeholder='Feed Name (e.g., BBC World)'>
      <input type='text' id='modal-feed-url' class='modal-input' placeholder='Feed URL (e.g., https://...)'>
      <div class='modal-buttons'>
        <button type='button' class='modal-btn modal-btn-cancel' onclick='hideAddFeedModal()'>Cancel</button>
        <button type='button' class='modal-btn modal-btn-add' onclick='addFeedFromModal()'>Add</button>
      </div>
    </div>
  </div>

  <div class='item-container' style='border-radius: 8px; margin: 10px;'>
    <div class='item-container-header' style='background-color: #34a853; color: white;'>Reading Speed</div>
    <div class='item-container-content' style='padding: 15px;'>
      <label class='item'>
        <div class='item-input' style='text-align: center;'>
          <input type='range' id='input_reading_speed' min='150' max='600' step='50' value='400' style='width: 100%;'
            oninput='updateSpeedDisplay()'>
        </div>
      </label>
      <div style='text-align: center; margin-top: 10px;'>
        <span id='speed_display' style='font-size: 1.2em; font-weight: bold; color: #34a853;'>400 WPM</span>
        <div style='font-size: 0.85em; color: #666; margin-top: 5px;'>
          <span style='float: left;'>Slow</span>
          <span style='float: right;'>Fast</span>
          <div style='clear: both;'></div>
        </div>
      </div>
    </div>
  </div>

  <div class='item-container' style='border-radius: 8px; margin: 10px;'>
    <div class='item-container-header' style='background-color: #ff9800; color: white;'>Display Options</div>
    <div class='item-container-content' style='padding: 15px;'>
      <label class='item' style='display: flex; align-items: center; justify-content: space-between;'>
        <div style='flex: 1;'>
          <div style='font-weight: bold; margin-bottom: 5px;'>Keep Backlight On</div>
          <div style='font-size: 0.85em; color: #666;'>Keeps screen lit while reading for better visibility</div>
        </div>
        <div style='margin-left: 15px;'>
          <input type='checkbox' id='input_backlight_enabled' checked style='width: 24px; height: 24px;'>
        </div>
      </label>
    </div>
  </div>

  <div class='item-container'>
    <div class='button-container'>
      <input id='submit_button' type='button' class='item-button' value='SUBMIT'>
    </div>
  </div>

  <div class='item-container-footer'>
    If you REALLY like this app <br>
    you can give me a little something on Paypal <a href='https://paypal.me/ChrJeannette'>here</a>. <br>
    - Otherwise just enjoy it, it's free !<br><br><br>
  </div>

</body>

<script>
  // Default feeds (the 6 presets)
  var defaultFeeds = [
    { name: 'BBC World', url: 'https://feeds.bbci.co.uk/news/world/rss.xml' },
    { name: 'NY Times', url: 'https://rss.nytimes.com/services/xml/rss/nyt/World.xml' },
    { name: 'NPR News', url: 'https://feeds.npr.org/1001/rss.xml' },
    { name: 'Guardian', url: 'https://www.theguardian.com/world/rss' },
    { name: 'Le Monde', url: 'https://www.lemonde.fr/rss/une.xml' },
    { name: 'Reuters', url: 'https://feeds.reuters.com/reuters/topNews' }
  ];

  // Current feeds list
  var feeds = [];
  var draggedItem = null;

  function loadFeeds() {
    var stored = localStorage.getItem('rss_feeds');
    if (stored) {
      try {
        feeds = JSON.parse(stored);
      } catch (e) {
        feeds = defaultFeeds.slice();
      }
    } else {
      feeds = defaultFeeds.slice();
    }
    renderFeedList();
  }

  function saveFeeds() {
    localStorage.setItem('rss_feeds', JSON.stringify(feeds));
  }

  function renderFeedList() {
    var list = document.getElementById('feed-list');
    list.innerHTML = '';

    feeds.forEach(function (feed, index) {
      var li = document.createElement('li');
      li.className = 'feed-item';
      li.dataset.index = index;

      var dragHandle = document.createElement('span');
      dragHandle.className = 'feed-drag-handle';
      dragHandle.textContent = '☰';
      dragHandle.draggable = true;
      
      var feedName = document.createElement('span');
      feedName.className = 'feed-name';
      feedName.textContent = feed.name;
      
      var deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'feed-delete';
      deleteBtn.textContent = '✕';
      deleteBtn.onclick = function() { deleteFeed(index); };
      
      li.appendChild(dragHandle);
      li.appendChild(feedName);
      li.appendChild(deleteBtn);

      // Drag events only on handle
      dragHandle.addEventListener('dragstart', function(e) { handleDragStart.call(li, e); });
      li.addEventListener('dragend', handleDragEnd);
      li.addEventListener('dragover', handleDragOver);
      li.addEventListener('drop', handleDrop);
      li.addEventListener('dragleave', handleDragLeave);

      // Touch events only on handle for mobile
      dragHandle.addEventListener('touchstart', function(e) { handleTouchStart.call(li, e); }, { passive: false });
      dragHandle.addEventListener('touchmove', handleTouchMove, { passive: false });
      dragHandle.addEventListener('touchend', handleTouchEnd);

      list.appendChild(li);
    });
  }

  function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function deleteFeed(index) {
    if (feeds.length <= 1) {
      alert('You must keep at least one feed.');
      return;
    }
    feeds.splice(index, 1);
    saveFeeds();
    renderFeedList();
  }

  function resetFeeds() {
    if (confirm('Reset all feeds to default? Your custom feeds will be removed.')) {
      feeds = defaultFeeds.slice();
      saveFeeds();
      renderFeedList();
    }
  }

  function showAddFeedModal() {
    document.getElementById('modal-feed-name').value = '';
    document.getElementById('modal-feed-url').value = '';
    document.getElementById('add-feed-modal').classList.add('show');
  }

  function hideAddFeedModal() {
    document.getElementById('add-feed-modal').classList.remove('show');
  }

  function addFeedFromModal() {
    var name = document.getElementById('modal-feed-name').value.trim();
    var url = document.getElementById('modal-feed-url').value.trim();

    if (!name) {
      alert('Please enter a feed name.');
      return;
    }
    if (!url) {
      alert('Please enter a feed URL.');
      return;
    }

    feeds.push({ name: name, url: url });
    saveFeeds();
    renderFeedList();
    hideAddFeedModal();
  }

  // Drag and drop handlers
  function handleDragStart(e) {
    draggedItem = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', this.dataset.index);
  }

  function handleDragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('.feed-item').forEach(function (item) {
      item.classList.remove('drag-over');
    });
    draggedItem = null;
  }

  function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    if (this !== draggedItem) {
      this.classList.add('drag-over');
    }
  }

  function handleDragLeave(e) {
    this.classList.remove('drag-over');
  }

  function handleDrop(e) {
    e.preventDefault();
    this.classList.remove('drag-over');

    if (draggedItem && this !== draggedItem) {
      var fromIndex = parseInt(draggedItem.dataset.index);
      var toIndex = parseInt(this.dataset.index);

      var item = feeds.splice(fromIndex, 1)[0];
      feeds.splice(toIndex, 0, item);

      saveFeeds();
      renderFeedList();
    }
  }

  // Touch support for mobile drag
  var touchStartY = 0;
  var touchedItem = null;

  function handleTouchStart(e) {
    touchedItem = this;
    touchStartY = e.touches[0].clientY;
  }

  function handleTouchMove(e) {
    if (!touchedItem) return;
    e.preventDefault();

    var touch = e.touches[0];
    var elements = document.elementsFromPoint(touch.clientX, touch.clientY);
    var targetItem = elements.find(function (el) {
      return el.classList && el.classList.contains('feed-item') && el !== touchedItem;
    });

    document.querySelectorAll('.feed-item').forEach(function (item) {
      item.classList.remove('drag-over');
    });

    if (targetItem) {
      targetItem.classList.add('drag-over');
    }
  }

  function handleTouchEnd(e) {
    if (!touchedItem) return;

    var touch = e.changedTouches[0];
    var elements = document.elementsFromPoint(touch.clientX, touch.clientY);
    var targetItem = elements.find(function (el) {
      return el.classList && el.classList.contains('feed-item') && el !== touchedItem;
    });

    if (targetItem) {
      var fromIndex = parseInt(touchedItem.dataset.index);
      var toIndex = parseInt(targetItem.dataset.index);

      var item = feeds.splice(fromIndex, 1)[0];
      feeds.splice(toIndex, 0, item);

      saveFeeds();
      renderFeedList();
    }

    document.querySelectorAll('.feed-item').forEach(function (item) {
      item.classList.remove('drag-over');
    });
    touchedItem = null;
  }

  function updateSpeedDisplay() {
    var speedInput = document.getElementById('input_reading_speed');
    var speedDisplay = document.getElementById('speed_display');
    var speedHeader = document.querySelector('.item-container:has(#input_reading_speed) .item-container-header');
    
    var speed = parseInt(speedInput.value);
    
    // Green up to 500 WPM, then orange
    var color;
    if (speed <= 500) {
      color = '#34a853'; // Green
    } else {
      color = '#ff9800'; // Orange
    }
    
    speedDisplay.textContent = speedInput.value + ' WPM';
    speedDisplay.style.color = color;
    if (speedHeader) {
      speedHeader.style.backgroundColor = color;
    }
  }

  function getConfigData() {
    var input_reading_speed = document.getElementById('input_reading_speed');
    var input_backlight_enabled = document.getElementById('input_backlight_enabled');

    var options = {
      'rss_feeds': feeds,
      'reading_speed_wpm': parseInt(input_reading_speed.value),
      'backlight_enabled': input_backlight_enabled.checked
    };

    // Save for next launch
    localStorage.setItem('rss_feeds', JSON.stringify(feeds));
    localStorage.setItem('reading_speed_wpm', options['reading_speed_wpm']);
    localStorage.setItem('backlight_enabled', options['backlight_enabled']);

    console.log('Got options: ' + JSON.stringify(options));
    return options;
  }

  function getQueryParam(variable, defaultValue) {
    var query = location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=');
      if (pair[0] === variable) {
        return decodeURIComponent(pair[1]);
      }
    }
    return defaultValue || false;
  }

  var submitButton = document.getElementById('submit_button');
  submitButton.addEventListener('click', function () {
    console.log('Submit');

    // Set the return URL depending on the runtime environment
    var return_to = getQueryParam('return_to', 'pebblejs://close#');
    document.location = return_to + encodeURIComponent(JSON.stringify(getConfigData()));
  });

  (function () {
    var input_reading_speed = document.getElementById('input_reading_speed');
    var input_backlight_enabled = document.getElementById('input_backlight_enabled');

    input_reading_speed.value = localStorage['reading_speed_wpm'] || '270';
    input_backlight_enabled.checked = localStorage['backlight_enabled'] !== 'false'; // Default true
    updateSpeedDisplay();

    // Load feeds
    loadFeeds();
  })();
</script>

</html>